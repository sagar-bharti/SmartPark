<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Smart Park ‚Äì Live Booking</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Segoe UI', Arial, sans-serif; }
        body { background: #f5f7fa; }
        header { background: #ffffff; padding: 15px 60px; display: flex; align-items: center; justify-content: space-between; box-shadow: 0 2px 8px rgba(0,0,0,0.08); position: sticky; top: 0; z-index: 1000; }
        .logo { font-size: 26px; font-weight: bold; color: #2ecc71; cursor: pointer; }
        nav a { margin: 0 15px; text-decoration: none; color: #444; font-weight: 500; }
        #home-1 { height: calc(100vh - 80px); background: linear-gradient(rgba(0,140,200,0.8), rgba(0,140,200,0.8)), url("https://images.unsplash.com/photo-1506521781263-d8422e82f27a") center/cover; display: flex; flex-direction: column; align-items: center; justify-content: center; text-align: center; color: #fff; padding: 20px; }
        .booking-form { background: #ffffff; padding: 20px; border-radius: 8px; display: flex; flex-direction: column; gap: 15px; width: 100%; max-width: 500px; box-shadow: 0 10px 30px rgba(0,0,0,0.2); }
        .booking-form input, .booking-form select { padding: 14px; border: 1px solid #ddd; border-radius: 5px; width: 100%; color: #333; }
        .booking-form button { background: #2ecc71; color: white; border: none; padding: 14px 25px; font-weight: bold; border-radius: 5px; cursor: pointer; width: 100%; }
        #home-2 { display: none; padding: 50px 60px; background: #f5f7fa; min-height: 100vh; }
        .parking-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 25px; margin-top: 30px; }
        .parking-card { background: white; border-radius: 12px; overflow: hidden; box-shadow: 0 4px 15px rgba(0,0,0,0.05); border-top: 5px solid #2ecc71; }
        .parking-card img { width: 100%; height: 200px; object-fit: cover; }
        .card-info { padding: 20px; }
        .price-tag { font-size: 22px; font-weight: bold; color: #2c3e50; margin: 10px 0; }
        .confirm-btn { display: block; width: 100%; text-align: center; background: #3498db; color: white; padding: 12px; text-decoration: none; border-radius: 5px; margin-top: 15px; cursor: pointer; border:none; }
        
        /* Mobile Fix */
        @media (max-width: 768px) { header { padding: 15px 20px; flex-direction: column; } .booking-form { width: 100%; } #home-2 { padding: 20px; } }
    </style>
</head>
<body>

    <header>
        <div class="logo" onclick="location.reload()">Smart Park</div>
        <nav>
            <a href="#" onclick="location.reload()">Home</a>
            <a href="#">Features</a>
            <a href="#">About Us</a>
        </nav>
        <div class="phone">üìû +91 808 505 5261</div>
    </header>

    <div id="main-content">
        <section id="home-1">
            <h1 style="margin-bottom: 10px;">Best Deals For Parking!</h1>
            <p style="margin-bottom: 20px;">Book your spot in seconds and save money.</p>
            
            <form class="booking-form" id="bookingForm">
                <select id="loc" required>
                    <option value="">Select Location</option>
                    <option value="Nearby">Nearby</option>
                </select>
                <input type="text" placeholder="Name" required>
                <input type="tel" id="user-phone" placeholder="Mobile Number (10 digits)" required>
                
                <button type="submit" id="send-otp-btn">Send OTP</button>

                <div id="otp-section" style="display: none; flex-direction: column; gap: 10px; border-top: 1px solid #eee; padding-top: 15px;">
                    <input type="text" id="otp-code" placeholder="Enter 6-digit OTP">
                    <button type="button" onclick="window.verifyOTP()" style="background: #3498db;">Verify & Show Parking</button>
                </div>
            </form>
            <div id="recaptcha-container"></div>
        </section>
    </div>

    <section id="home-2">
        <h2 style="text-align:center;">Available Parking Spaces</h2>
        <div class="parking-grid" id="parking-grid"></div>
    </section>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, collection, onSnapshot, doc, updateDoc, increment, getDocs } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
        import { getAuth, RecaptchaVerifier, signInWithPhoneNumber } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

        const firebaseConfig = {
            apiKey: "AIzaSyCRK6QnA0F_MNkSdNiVnNgypt2TzlaVomQ",
            authDomain: "smart-parking-3d52f.firebaseapp.com",
            projectId: "smart-parking-3d52f",
            storageBucket: "smart-parking-3d52f.firebasestorage.app",
            messagingSenderId: "139926831182",
            appId: "1:139926831182:web:14ce31ebdaa2b5acac431f"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);

        // Global Variables
        window.recaptchaVerifier = null;
        window.confirmationResult = null;

        const bookingForm = document.getElementById('bookingForm');
        const mainContent = document.getElementById('main-content');
        const home2 = document.getElementById('home-2');
        const grid = document.getElementById('parking-grid');

        // OTP Verification Logic
        window.verifyOTP = async () => {
            const code = document.getElementById('otp-code').value;
            if(!code) { alert("Please enter OTP"); return; }
            try {
                await window.confirmationResult.confirm(code);
                alert("Verification Successful!");
                mainContent.style.display = 'none';
                home2.style.display = 'block';
                loadParkingData();
            } catch (error) {
                alert("Invalid OTP. Error: " + error.message);
            }
        };

        // Form Submit -> Send OTP
        bookingForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const phone = document.getElementById('user-phone').value;
            
            if(phone.length < 10) {
                alert("Please enter a valid 10-digit phone number.");
                return;
            }

            const phoneNumber = "+91" + phone;

            try {
                if(!window.recaptchaVerifier) {
                    window.recaptchaVerifier = new RecaptchaVerifier(auth, 'recaptcha-container', { 'size': 'invisible' });
                }
                
                window.confirmationResult = await signInWithPhoneNumber(auth, phoneNumber, window.recaptchaVerifier);
                alert("OTP Sent to " + phoneNumber);
                document.getElementById('otp-section').style.display = 'flex';
                document.getElementById('send-otp-btn').innerText = "Resend OTP";
            } catch (error) {
                alert("Error sending SMS: " + error.message);
                console.error(error);
            }
        });

        // Load Parking Data
        async function loadParkingData() {
            grid.innerHTML = "<h3 style='grid-column: 1/-1; text-align:center;'>Fetching Live Data...</h3>";
            
            navigator.geolocation.getCurrentPosition((position) => {
                const userLat = position.coords.latitude;
                const userLng = position.coords.longitude;

                onSnapshot(collection(db, "parking_spots"), (snapshot) => {
                    grid.innerHTML = ""; 
                    snapshot.forEach((docSnap) => {
                        const spot = docSnap.data();
                        const id = docSnap.id;
                        
                        grid.innerHTML += `
                            <div class="parking-card">
                                <img src="${spot.image || 'https://via.placeholder.com/300x200'}" alt="parking">
                                <div class="card-info">
                                    <h3>${spot.name}</h3>
                                    <p style="color:${spot.available > 0 ? '#2ecc71' : '#e74c3c'}; font-weight:bold; margin-top:5px;">
                                        Available: ${spot.available} Slots
                                    </p>
                                    <div class="price-tag">‚Çπ${spot.price}/hr</div>
                                    <button onclick="window.location.href='booking-details.html?spotId=${id}'" class="confirm-btn" ${spot.available <= 0 ? 'disabled' : ''}>
                                        ${spot.available > 0 ? 'Book Now' : 'Full'}
                                    </button>
                                </div>
                            </div>`;
                    });
                });
            });
        }
    </script>
</body>
</html>

    <script type="module">

        // --- Naya logic: Purani bookings check karne ke liye ---
async function checkAndReleaseSlots() {
    const { getDocs } = await import("https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js");
    const querySnapshot = await getDocs(collection(db, "parking_spots"));
    const currentTime = Date.now();

    for (const docSnap of querySnapshot.docs) {
        const spot = docSnap.data();
        // Agar lastExpiry nikal chuki hai toh slot ko +1 karein
        if (spot.lastExpiry && currentTime > spot.lastExpiry) {
            const spotRef = doc(db, "parking_spots", docSnap.id);
            await updateDoc(spotRef, { 
                available: increment(1),
                lastExpiry: null // Reset kar dein taaki bar-bar loop na chale
            });
        }
    }
}




    // 1. Imports mein onSnapshot add kiya gaya hai
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getFirestore, collection, onSnapshot, doc, updateDoc, increment } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    const firebaseConfig = {
        apiKey: "AIzaSyCRK6QnA0F_MNkSdNiVnNgypt2TzlaVomQ",
        authDomain: "smart-parking-3d52f.firebaseapp.com",
        projectId: "smart-parking-3d52f",
        storageBucket: "smart-parking-3d52f.firebasestorage.app",
        messagingSenderId: "139926831182",
        appId: "1:139926831182:web:14ce31ebdaa2b5acac431f"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    const bookingForm = document.getElementById('bookingForm');
    const mainContent = document.getElementById('main-content');
    const home2 = document.getElementById('home-2');
    const grid = document.getElementById('parking-grid');



    // Recaptcha setup
window.setupRecaptcha = () => {
    window.recaptchaVerifier = new RecaptchaVerifier(auth, 'recaptcha-container', {
        'size': 'invisible'
    });
};

// 1. Pehle OTP bhejien
async function sendOTP(phoneNumber) {
    window.setupRecaptcha();
    const appVerifier = window.recaptchaVerifier;
    
    // India ke liye +91 lagana zaroori hai
    const finalPhone = phoneNumber.startsWith('+') ? phoneNumber : "+91" + phoneNumber;

    try {
        window.confirmationResult = await signInWithPhoneNumber(auth, finalPhone, appVerifier);
        alert("OTP sent to " + finalPhone);
        document.getElementById('otp-section').style.display = 'block'; // OTP box dikhayien
    } catch (error) {
        alert("SMS Error: " + error.message);
    }
}

// 2. OTP Verify hone par hi search chale
window.verifyOTP = async () => {
    const code = document.getElementById('otp-code').value;
    try {
        await window.confirmationResult.confirm(code);
        alert("Verification Successful!");
        
        // Agar verify ho gaya, tabhi search result dikhayien
        mainContent.style.display = 'none';
        home2.style.display = 'block';
        await checkAndReleaseSlots(); 
        loadParkingData();
    } catch (error) {
        alert("Invalid OTP. Try again.");
    }
};

// 3. Form submit event ko badlein
bookingForm.addEventListener('submit', function(e) {
    e.preventDefault();
    const phone = document.querySelector('input[type="tel"]').value;
    
    if(phone.length < 10) {
        alert("Please enter a valid 10-digit number");
        return;
    }
    
    // Ab search karne ke bajaye pehle OTP bhejein
    sendOTP(phone);
});

    // --- 2. Doori nikalne ka function (Distance Calculation) ---
    function calculateDistance(lat1, lon1, lat2, lon2) {
        const R = 6371; // Earth's radius in km
        const dLat = (lat2 - lat1) * Math.PI / 180;
        const dLon = (lon2 - lon1) * Math.PI / 180;
        const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
                  Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) * Math.sin(dLon/2) * Math.sin(dLon/2);
        const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
        return (R * c).toFixed(1); 
    }

    // --- 3. Updated Real-time Load Function ---
    async function loadParkingData() {
        grid.innerHTML = "<h3 style='grid-column: 1/-1; text-align:center;'>Finding Nearby Parking...</h3>";
        
        // User ki GPS location mangna
        navigator.geolocation.getCurrentPosition((position) => {
            const userLat = position.coords.latitude;
            const userLng = position.coords.longitude;

            // Real-time listener: Jab bhi Firebase mein data badlega, ye apne aap update hoga
            const q = collection(db, "parking_spots");
            onSnapshot(q, (snapshot) => {
                grid.innerHTML = ""; 

                snapshot.forEach((docSnap) => {
                    const spot = docSnap.data();
                    const id = docSnap.id;
                    
                    // Distance calculate karein
                    const distance = calculateDistance(userLat, userLng, spot.lat, spot.lng);

                    grid.innerHTML += `
                        <div class="parking-card">
                            <img src="${spot.image || 'https://via.placeholder.com/300x200'}" alt="parking">
                            <div class="card-info">
                                <h3>${spot.name}</h3>
                                <p style="color:#666; font-size:14px;">üìç ${distance} km away</p>
                                <p style="color:${spot.available > 0 ? '#2ecc71' : '#e74c3c'}; font-weight:bold; margin-top:5px;">
                                    Available: ${spot.available} Slots
                                </p>
                                <div class="price-tag">${spot.price === "Free" || spot.price == 0 ? 'Free' : '‚Çπ' + spot.price + '/hr'}</div>
                                
                                <a href="https://www.google.com/maps/dir/?api=1&destination=${spot.lat},${spot.lng}" 
                                   target="_blank" class="confirm-btn" style="background:#3498db; text-decoration:none; margin-bottom:8px;">
                                   üß≠ Start Navigation
                                </a>

                                <button onclick="window.confirmBooking('${id}')" class="confirm-btn" ${spot.available <= 0 ? 'disabled' : ''}>
                                    ${spot.available > 0 ? 'Book Now' : 'Full'}
                                </button>
                            </div>
                        </div>
                    `;
                });
            }, (error) => {
                grid.innerHTML = "<p>Error: " + error.message + "</p>";
            });
        }, (err) => {
            alert("Please enable GPS location to see nearby parking.");
        });
    }

    // 4. Booking Logic: Ab ye redirect karega naye page par
    window.confirmBooking = (id) => {
        window.location.href = `booking-details.html?spotId=${id}`;
    };

    bookingForm.addEventListener('submit', function(e) {
        e.preventDefault();
        mainContent.style.display = 'none';
        home2.style.display = 'block';
        window.scrollTo(0, 0);
        loadParkingData();
    });
</script>
</body>
</html>